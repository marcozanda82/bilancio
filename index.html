<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tracker Definitivo e Stabile</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: #f4f7f9; color: #333; margin: 0; padding: 20px; display: flex; justify-content: center; }
        .container { width: 100%; max-width: 800px; background-color: #ffffff; padding: 25px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        h1, h2, h3 { color: #0d47a1; border-bottom: 2px solid #e0e0e0; padding-bottom: 10px; margin-top: 0; }
        h2 { font-size: 1.4em; margin-top: 30px; }
        h3 { font-size: 1.2em; border-bottom: none; margin-top: 15px; margin-bottom: 10px; }
        .sezione { margin-bottom: 25px; padding: 20px; background-color: #fafafa; border: 1px solid #e0e0e0; border-radius: 8px; border-left-width: 5px; }
        label { display: block; margin-bottom: 8px; font-weight: 600; color: #555; }
        input[type="text"], input[type="number"] { width: 100%; padding: 12px; margin-bottom: 15px; border: 1px solid #ccc; border-radius: 6px; box-sizing: border-box; font-size: 1em; }
        button { background-color: #1976d2; color: white; padding: 12px 20px; border: none; border-radius: 6px; cursor: pointer; font-size: 1em; font-weight: 600; transition: background-color 0.3s; }
        button:hover { background-color: #1565c0; }
        #form-allenamento button { background-color: #2e7d32; }
        #form-allenamento button:hover { background-color: #1b5e20; }
        #riepilogo p { font-size: 1.1em; margin: 12px 0; }
        #riepilogo .valore-grande { font-weight: 700; font-size: 1.4em; color: #d32f2f; }
        #riepilogo .valore-consumato { font-weight: 600; color: #1976d2; }
        #riepilogo .valore-bruciato { font-weight: 600; color: #2e7d32; }
        progress { width: 100%; height: 25px; border-radius: 6px; margin-top: 5px; }
        table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid #ddd; vertical-align: middle; }
        th { background-color: #f2f2f2; font-weight: 600; }
        td:first-child, th:first-child { color: #666; font-size: 0.9em; text-align: center; }
        .delete-btn { background-color: transparent; border: none; color: #d32f2f; font-size: 1.3em; font-weight: bold; cursor: pointer; padding: 0 8px; border-radius: 50%; line-height: 1; }
        .delete-btn:hover { background-color: #ffebee; color: #b71c1c; }
        .proiezione-ok { border-left-color: #4caf50; } .proiezione-attenzione { border-left-color: #ff9800; } .proiezione-pericolo { border-left-color: #f44336; } .proiezione-neutra { border-left-color: #9e9e9e; }
        #builder-input-riga { display: grid; grid-template-columns: 2fr 1fr 1fr 1fr; gap: 10px; align-items: flex-start; }
        #builder-input-riga div { display: flex; flex-direction: column; }
        #builder-input-riga label { font-size: 0.8em; margin-bottom: 4px; }
        #builder-input-riga input { margin-bottom: 0; }
        #btn-aggiungi-ingrediente { background-color: #5c6bc0; margin-top: 15px; width: 100%; }
        #builder-riepilogo { background-color: #e8f5e9; padding: 15px; border-radius: 6px; margin-top: 20px; }
        #riepilogo-pasto-table tfoot td { font-weight: bold; border-top: 2px solid #333; background-color: #dcedc8; }
        #btn-registra-pasto { width: 100%; padding: 15px; font-size: 1.2em; background-color: #d84315; }
        #btn-registra-pasto:disabled { background-color: #ccc; cursor: not-allowed; }
        #link-storico { display: block; text-align: center; margin-bottom: 20px; padding: 10px; background-color: #607d8b; color: white; text-decoration: none; border-radius: 6px; font-weight: 600; }
        #backup-reminder { border: 2px dashed #ff9800; padding: 15px; margin-top: 15px; border-radius: 6px; background-color: #fffde7; text-align: center; }
        #import-file { margin-top: 10px; }
        @media (max-width: 700px) { #builder-input-riga { grid-template-columns: 1fr 1fr; } }
    </style>
</head>
<body>
    <div class="container">
        <h1>Tracker Definitivo</h1>
        <a href="storico.html" id="link-storico">ðŸ“Š Vedi Storico</a>
        <div id="proiezione" class="sezione proiezione-neutra"><h2>Proiezione del Trend</h2><p id="testo-proiezione">Inizia a registrare i dati per vedere un'analisi.</p></div>
        <div id="riepilogo" class="sezione">
            <h2>Riepilogo di Oggi</h2>
            <p>Proteine restanti: <span id="restanti-proteine" class="valore-grande"></span> g</p><progress id="progress-proteine" value="0"></progress>
            <p>Consumate: <span id="totale-proteine" class="valore-consumato">0</span> g / <span id="obiettivo-proteine"></span> g</p><hr style="margin: 20px 0; border: 1px solid #eee;">
            <p>Calorie restanti: <span id="restanti-calorie" class="valore-grande"></span> kcal</p><progress id="progress-calorie" value="0"></progress>
            <p>Consumate: <span id="totale-calorie" class="valore-consumato">0</span> kcal / <span id="obiettivo-calorie"></span> kcal</p>
            <p style="margin-top:15px;">Calorie Bruciate (Workout): <span id="workout-calories-totali" class="valore-bruciato">0</span> kcal</p>
        </div>
        <div id="meal-builder" class="sezione">
            <h2>Costruttore e Registrazione Pasto</h2>
            <label for="nome-pasto">Nome del Pasto (es. Pranzo, Cena)</label><input type="text" id="nome-pasto" placeholder="Pranzo di oggi">
            <hr><h3>Aggiungi Ingrediente</h3>
            <div id="builder-input-riga">
                <div><label>Alimento</label><input type="text" id="builder-desc" placeholder="es. Tofu" list="food-database-list"></div>
                <div><label>Prot/100g</label><input type="number" id="builder-prot" min="0" step="0.1"></div>
                <div><label>Kcal/100g</label><input type="number" id="builder-kcal" min="0"></div>
                <div><label>QuantitÃ  (g)</label><input type="number" id="builder-qta" min="0"></div>
            </div>
            <datalist id="food-database-list"></datalist>
            <button id="btn-aggiungi-ingrediente">Aggiungi Ingrediente al Pasto</button>
            <div id="builder-riepilogo" style="margin-top:25px;">
                <h3>Riepilogo Pasto Corrente</h3>
                <table id="riepilogo-pasto-table">
                    <thead><tr><th>Alimento</th><th>Proteine (g)</th><th>Calorie (kcal)</th><th>Azione</th></tr></thead>
                    <tbody id="riepilogo-pasto-body"></tbody>
                    <tfoot><tr><td><strong>TOTALE</strong></td><td><strong id="builder-totale-proteine">0.0</strong></td><td><strong id="builder-totale-calorie">0</strong></td><td></td></tr></tfoot>
                </table>
            </div>
            <button id="btn-registra-pasto" style="margin-top: 20px;" disabled>Registra Pasto nel Diario</button>
        </div>
        <div class="sezione">
            <h2>Registra Allenamento</h2>
            <form id="form-allenamento"><input type="text" id="descrizione-allenamento" placeholder="Descrizione Allenamento"><input type="number" id="calorie-bruciate" min="0" required placeholder="Calorie Bruciate (kcal)"><button type="submit">Aggiungi Allenamento</button></form>
            <table id="log-allenamenti"><thead><tr><th>Data</th><th>Descrizione</th><th>Calorie Bruciate</th><th>Azione</th></tr></thead><tbody id="log-allenamenti-body"></tbody></table>
        </div>
        <div class="sezione">
            <h2>Diario Giornaliero</h2>
            <table id="log-pasti"><thead><tr><th>Data</th><th>Descrizione</th><th>Proteine (g)</th><th>Calorie (kcal)</th><th>Azione</th></tr></thead><tbody id="log-body"></tbody></table>
        </div>
        <div id="backup-sezione" class="sezione">
            <h2>Backup e Ripristino Dati</h2><p>Salva i tuoi dati in un file per sicurezza o per trasferirli su un altro dispositivo.</p><button id="btn-export">Esporta Backup</button><hr><label for="import-file">Importa da un file di backup:</label><input type="file" id="import-file" accept=".json,.txt"><div id="backup-reminder" style="display:none;"></div>
        </div>
    </div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    // === COSTANTI E STATO GLOBALE ===
    const OBIETTIVO_PROTEINE = 120; 
    const OBIETTIVO_CALORIE = 2200;
    const TDEE_BASE = 2311;
    const PROTEINE_SOGLIA_MANTENIMENTO = 90;
    
    let datiGiornalieri = { proteine: 0, calorie: 0, log: [], workoutCalorie: 0, workoutLog: [] };
    let pastoCorrente = [];
    let foodDatabase = {};

    // === RIFERIMENTI DOM ===
    const proiezioneDiv = document.getElementById('proiezione'), testoProiezione = document.getElementById('testo-proiezione');
    const formAllenamento = document.getElementById('form-allenamento');
    const spanTotaleProteine = document.getElementById('totale-proteine'), spanTotaleCalorie = document.getElementById('totale-calorie');
    const spanRestantiProteine = document.getElementById('restanti-proteine'), spanRestantiCalorie = document.getElementById('restanti-calorie');
    const progressProteine = document.getElementById('progress-proteine'), progressCalorie = document.getElementById('progress-calorie');
    const logBody = document.getElementById('log-body');
    const logAllenamentiBody = document.getElementById('log-allenamenti-body'), tabellaAllenamenti = document.getElementById('log-allenamenti');
    const spanWorkoutCalories = document.getElementById('workout-calories-totali');
    const btnAggiungiIngrediente = document.getElementById('btn-aggiungi-ingrediente');
    const btnRegistraPasto = document.getElementById('btn-registra-pasto');
    const inputNomePasto = document.getElementById('nome-pasto');
    const riepilogoPastoBody = document.getElementById('riepilogo-pasto-body');
    const builderDesc = document.getElementById('builder-desc'), builderProt = document.getElementById('builder-prot'), builderKcal = document.getElementById('builder-kcal'), builderQta = document.getElementById('builder-qta');
    const builderTotaleProteine = document.getElementById('builder-totale-proteine');
    const builderTotaleCalorie = document.getElementById('builder-totale-calorie');
    const foodDatalist = document.getElementById('food-database-list');
    const btnExport = document.getElementById('btn-export'), fileImport = document.getElementById('import-file'), backupReminderDiv = document.getElementById('backup-reminder');

    // === FUNZIONI ===
    function getTodayString(format = 'ymd') {
        const today = new Date();
        if (format === 'ymd') return today.toISOString().split('T')[0];
        const day = String(today.getDate()).padStart(2, '0');
        const month = String(today.getMonth() + 1).padStart(2, '0');
        return `${day}/${month}`;
    }

    function salvaGiornoCorrente() {
        localStorage.setItem('trackerGiornoCorrente', JSON.stringify({ data: getTodayString('ymd'), dati: datiGiornalieri }));
    }

    function salvaFoodDatabase() {
        localStorage.setItem('trackerFoodDatabase', JSON.stringify(foodDatabase));
    }

    function caricaFoodDatabase() {
        const dbSalvato = localStorage.getItem('trackerFoodDatabase');
        if (dbSalvato) {
            foodDatabase = JSON.parse(dbSalvato);
            aggiornaDatalist();
        }
    }
    
    function aggiornaDatalist() {
        foodDatalist.innerHTML = '';
        for (const foodName in foodDatabase) {
            const option = document.createElement('option');
            option.value = foodName.charAt(0).toUpperCase() + foodName.slice(1);
            foodDatalist.appendChild(option);
        }
    }

    function salvaMealBuilder() {
        const statoBuilder = { nome: inputNomePasto.value, ingredienti: pastoCorrente };
        localStorage.setItem('trackerMealBuilderState', JSON.stringify(statoBuilder));
    }

    function caricaMealBuilder() {
        const statoSalvato = JSON.parse(localStorage.getItem('trackerMealBuilderState'));
        if (statoSalvato) {
            inputNomePasto.value = statoSalvato.nome || '';
            pastoCorrente = statoSalvato.ingredienti || [];
            aggiornaRiepilogoPasto();
        }
    }

    function archiviaGiornoPrecedente(datiDaArchiviare) {
        const storico = JSON.parse(localStorage.getItem('trackerStorico')) || [];
        const calorieBruciateTotali = TDEE_BASE + datiDaArchiviare.dati.workoutCalorie;
        const deficitCalorico = calorieBruciateTotali - datiDaArchiviare.dati.calorie;
        let trendFinale = 'ok';
        if (deficitCalorico < -200) { trendFinale = datiDaArchiviare.dati.proteine < OBIETTIVO_PROTEINE * 0.9 ? 'pericolo' : 'attenzione'; }
        else if (datiDaArchiviare.dati.proteine < PROTEINE_SOGLIA_MANTENIMENTO) { trendFinale = 'pericolo'; }
        else if (datiDaArchiviare.dati.proteine < OBIETTIVO_PROTEINE) { trendFinale = 'attenzione'; }
        storico.push({ data: datiDaArchiviare.data, totali: { proteine: datiDaArchiviare.dati.proteine, calorie: datiDaArchiviare.dati.calorie, workoutCalorie: datiDaArchiviare.dati.workoutCalorie }, allenamenti: datiDaArchiviare.dati.workoutLog, trend: trendFinale });
        localStorage.setItem('trackerStorico', JSON.stringify(storico));
        localStorage.setItem('backupNeeded', 'true');
    }

    function gestisciAvvioApp() {
        const giornoCorrenteRaw = localStorage.getItem('trackerGiornoCorrente');
        if (giornoCorrenteRaw) {
            const giornoCorrenteProvvisorio = JSON.parse(giornoCorrenteRaw);
            if (giornoCorrenteProvvisorio.dati.log.length > 0 && typeof giornoCorrenteProvvisorio.dati.log[0].data === 'undefined') {
                const dataDelGiorno = giornoCorrenteProvvisorio.data;
                giornoCorrenteProvvisorio.dati.log.forEach(item => item.data = dataDelGiorno);
                giornoCorrenteProvvisorio.dati.workoutLog.forEach(item => item.data = dataDelGiorno);
                localStorage.setItem('trackerGiornoCorrente', JSON.stringify(giornoCorrenteProvvisorio));
            }
        }
        const giornoCorrenteSalvataggio = JSON.parse(localStorage.getItem('trackerGiornoCorrente'));
        const oggi = getTodayString('ymd');
        if (giornoCorrenteSalvataggio) {
            if (giornoCorrenteSalvataggio.data !== oggi && (giornoCorrenteSalvataggio.dati.calorie > 0 || giornoCorrenteSalvataggio.dati.workoutCalorie > 0)) {
                archiviaGiornoPrecedente(giornoCorrenteSalvataggio);
                datiGiornalieri = { proteine: 0, calorie: 0, log: [], workoutCalorie: 0, workoutLog: [] };
                localStorage.removeItem('trackerMealBuilderState');
            } else {
                datiGiornalieri = giornoCorrenteSalvataggio.dati;
            }
        }
        aggiornaUI();
        salvaGiornoCorrente();
        controllaNotificaBackup();
    }
    
    function aggiornaUI() {
        document.getElementById('obiettivo-proteine').textContent = OBIETTIVO_PROTEINE;
        document.getElementById('obiettivo-calorie').textContent = OBIETTIVO_CALORIE;
        progressProteine.max = OBIETTIVO_PROTEINE; progressCalorie.max = OBIETTIVO_CALORIE;
        spanTotaleProteine.textContent = datiGiornalieri.proteine.toFixed(1);
        spanTotaleCalorie.textContent = datiGiornalieri.calorie;
        spanWorkoutCalories.textContent = datiGiornalieri.workoutCalorie;
        const restantiProteine = OBIETTIVO_PROTEINE - datiGiornalieri.proteine;
        const restantiCalorie = OBIETTIVO_CALORIE - datiGiornalieri.calorie;
        spanRestantiProteine.textContent = restantiProteine.toFixed(1);
        spanRestantiCalorie.textContent = restantiCalorie;
        progressProteine.value = datiGiornalieri.proteine; progressCalorie.value = datiGiornalieri.calorie;
        
        logBody.innerHTML = '';
        datiGiornalieri.log.forEach((item, index) => {
            const dataFormattata = item.data ? `${item.data.split('-')[2]}/${item.data.split('-')[1]}` : getTodayString('gg/mm');
            logBody.insertRow().innerHTML = `<td>${dataFormattata}</td><td>${item.desc}</td><td>${item.prot.toFixed(1)}</td><td>${item.cal}</td><td><button class="delete-btn" data-type="pasto" data-index="${index}" title="Cancella pasto">&times;</button></td>`;
        });
        
        tabellaAllenamenti.style.display = datiGiornalieri.workoutLog.length > 0 ? 'table' : 'none';
        logAllenamentiBody.innerHTML = '';
        datiGiornalieri.workoutLog.forEach((item, index) => {
            const dataFormattata = item.data ? `${item.data.split('-')[2]}/${item.data.split('-')[1]}` : getTodayString('gg/mm');
            logAllenamentiBody.insertRow().innerHTML = `<td>${dataFormattata}</td><td>${item.desc}</td><td>${item.cal}</td><td><button class="delete-btn" data-type="allenamento" data-index="${index}" title="Cancella allenamento">&times;</button></td>`;
        });
        aggiornaProiezione();
    }
    
    function aggiornaProiezione() {
        const { calorie, proteine } = datiGiornalieri;
        const calorieBruciate = TDEE_BASE + datiGiornalieri.workoutCalorie;
        const deficit = calorieBruciate - calorie;
        let testo = '', classeCss = 'sezione proiezione-';
        if (calorie === 0 && datiGiornalieri.workoutCalorie === 0) { testo = "Inizia a registrare i dati per vedere un'analisi."; classeCss += 'neutra'; }
        else if (proteine < PROTEINE_SOGLIA_MANTENIMENTO) { testo = "ATTENZIONE: Apporto proteico basso (< 90g). Rischio di perdita muscolare, specialmente se il deficit calorico Ã¨ alto."; classeCss += 'pericolo'; }
        else if (proteine < OBIETTIVO_PROTEINE) { testo = "TREND DI MANTENIMENTO: Apporto proteico sufficiente per preservare la massa muscolare. Controlla le calorie per raggiungere il tuo obiettivo di peso."; classeCss += 'attenzione'; }
        else if (proteine >= OBIETTIVO_PROTEINE && deficit < 200) { testo = "TREND OTTIMALE: Eccellente! Hai superato l'obiettivo proteico con un bilancio calorico ideale per la ricomposizione corporea."; classeCss += 'ok'; }
        else { testo = "TREND POSITIVO: Apporto proteico ottimo! Assicurati solo che il deficit non sia troppo elevato per massimizzare i risultati."; classeCss += 'ok'; }
        proiezioneDiv.className = classeCss; testoProiezione.textContent = testo;
    }
    
    function aggiornaRiepilogoPasto() {
        let totalePastoProt = 0, totalePastoKcal = 0;
        riepilogoPastoBody.innerHTML = '';
        pastoCorrente.forEach(ingrediente => {
            totalePastoProt += ingrediente.prot;
            totalePastoKcal += ingrediente.cal;
            const riga = riepilogoPastoBody.insertRow();
            riga.innerHTML = `<td>${ingrediente.desc}</td><td>${ingrediente.prot.toFixed(1)}</td><td>${ingrediente.cal}</td><td><button class="delete-btn" data-ingrediente-id="${ingrediente.id}" title="Cancella ingrediente">&times;</button></td>`;
        });
        builderTotaleProteine.textContent = totalePastoProt.toFixed(1);
        builderTotaleCalorie.textContent = Math.round(totalePastoKcal);
        btnRegistraPasto.disabled = (pastoCorrente.length === 0);
    }

    function aggiungiIngrediente() {
        const p100 = parseFloat(builderProt.value) || 0;
        const k100 = parseFloat(builderKcal.value) || 0;
        const qta = parseFloat(builderQta.value) || 0;
        const desc = builderDesc.value.trim();
        if (!desc || qta <= 0) { alert('Per favore, inserisci nome e quantitÃ  dell\'alimento.'); return; }
        if (p100 > 0 || k100 > 0) { foodDatabase[desc.toLowerCase()] = { prot: p100, kcal: k100 }; salvaFoodDatabase(); aggiornaDatalist(); }
        const protCalcolate = (p100 / 100) * qta, kcalCalcolate = Math.round((k100 / 100) * qta);
        pastoCorrente.push({ id: Date.now(), desc: desc, prot: protCalcolate, cal: kcalCalcolate });
        builderDesc.value = ''; builderProt.value = ''; builderKcal.value = ''; builderQta.value = '';
        builderDesc.focus();
        aggiornaRiepilogoPasto();
        salvaMealBuilder();
    }

    function rimuoviIngrediente(idToRemove) {
        pastoCorrente = pastoCorrente.filter(ing => ing.id !== idToRemove);
        aggiornaRiepilogoPasto();
        salvaMealBuilder();
    }
    
    function esportaDati() {
        alert("VerrÃ  ora generato un file di backup. Salvalo in un posto sicuro!");
        const backupData = {
            giornoCorrente: JSON.parse(localStorage.getItem('trackerGiornoCorrente')),
            storico: JSON.parse(localStorage.getItem('trackerStorico')),
            databaseAlimenti: JSON.parse(localStorage.getItem('trackerFoodDatabase')),
            builderCorrente: JSON.parse(localStorage.getItem('trackerMealBuilderState'))
        };
        const blob = new Blob([JSON.stringify(backupData, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'tracker_backup.json';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        localStorage.removeItem('backupNeeded');
        controllaNotificaBackup();
    }

    function importaDati(event) {
        const file = event.target.files[0];
        if (!file) return;
        if (!confirm("Sei sicuro di voler sovrascrivere tutti i dati attuali con quelli del file di backup? L'operazione Ã¨ irreversibile.")) {
            event.target.value = null;
            return;
        }
        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const backupData = JSON.parse(e.target.result);
                if (backupData.giornoCorrente) localStorage.setItem('trackerGiornoCorrente', JSON.stringify(backupData.giornoCorrente));
                if (backupData.storico) localStorage.setItem('trackerStorico', JSON.stringify(backupData.storico));
                if (backupData.databaseAlimenti) localStorage.setItem('trackerFoodDatabase', JSON.stringify(backupData.databaseAlimenti));
                if (backupData.builderCorrente) localStorage.setItem('trackerMealBuilderState', JSON.stringify(backupData.builderCorrente));
                alert("Dati importati con successo! La pagina verrÃ  ora ricaricata.");
                location.reload();
            } catch (error) {
                alert("Errore: il file di backup non Ã¨ valido o Ã¨ corrotto.");
            }
        };
        reader.readAsText(file);
    }
    
    function controllaNotificaBackup() {
        if (localStorage.getItem('backupNeeded') === 'true') {
            backupReminderDiv.innerHTML = `<strong>Backup Consigliato!</strong> I dati di ieri sono stati archiviati. Clicca "Esporta Backup" per salvare una copia di sicurezza.`;
            backupReminderDiv.style.display = 'block';
        } else {
            backupReminderDiv.style.display = 'none';
        }
    }

    // === EVENT LISTENERS ===
    btnAggiungiIngrediente.addEventListener('click', aggiungiIngrediente);
    inputNomePasto.addEventListener('input', salvaMealBuilder);
    builderDesc.addEventListener('input', (e) => {
        const foodName = e.target.value.toLowerCase();
        if (foodDatabase[foodName]) {
            const foodData = foodDatabase[foodName];
            builderProt.value = foodData.prot;
            builderKcal.value = foodData.kcal;
        }
    });

    btnRegistraPasto.addEventListener('click', () => {
        const nomePasto = inputNomePasto.value.trim() || "Pasto da Builder";
        const totali = pastoCorrente.reduce((acc, curr) => { acc.prot += curr.prot; acc.cal += curr.cal; return acc; }, { prot: 0, cal: 0 });
        if (totali.cal > 0 || totali.prot > 0) {
            datiGiornalieri.proteine += totali.prot;
            datiGiornalieri.calorie += totali.cal;
            datiGiornalieri.log.push({ data: getTodayString('ymd'), desc: nomePasto, prot: totali.prot, cal: totali.cal });
            salvaGiornoCorrente();
            aggiornaUI();
            pastoCorrente = [];
            inputNomePasto.value = '';
            localStorage.removeItem('trackerMealBuilderState');
            aggiornaRiepilogoPasto();
        }
    });

    formAllenamento.addEventListener('submit', e => {
        e.preventDefault();
        const desc = document.getElementById('descrizione-allenamento').value || 'Allenamento';
        const cal = parseInt(document.getElementById('calorie-bruciate').value, 10);
        if (isNaN(cal) || cal <= 0) return;
        datiGiornalieri.workoutCalorie += cal;
        datiGiornalieri.workoutLog.push({ data: getTodayString('ymd'), desc: desc, cal: cal });
        salvaGiornoCorrente();
        aggiornaUI();
        e.target.reset();
    });

    document.body.addEventListener('click', (e) => {
        const target = e.target;
        if (target.hasAttribute('data-ingrediente-id')) {
            rimuoviIngrediente(parseInt(target.dataset.ingredienteId, 10));
        } else if (target.classList.contains('delete-btn') && target.hasAttribute('data-type')) {
            if (!confirm('Sei sicuro di voler cancellare questa voce?')) return;
            const type = target.dataset.type;
            const index = parseInt(target.dataset.index, 10);
            if (type === 'pasto' && datiGiornalieri.log[index]) {
                const item = datiGiornalieri.log[index];
                datiGiornalieri.proteine -= item.prot;
                datiGiornalieri.calorie -= item.cal;
                datiGiornalieri.log.splice(index, 1);
            } else if (type === 'allenamento' && datiGiornalieri.workoutLog[index]) {
                const item = datiGiornalieri.workoutLog[index];
                datiGiornalieri.workoutCalorie -= item.cal;
                datiGiornalieri.workoutLog.splice(index, 1);
            }
            salvaGiornoCorrente();
            aggiornaUI();
        }
    });

    btnExport.addEventListener('click', esportaDati);
    fileImport.addEventListener('change', importaDati);
    
    // === INIZIALIZZAZIONE APP ===
    caricaFoodDatabase();
    gestisciAvvioApp();
    caricaMealBuilder();
});
</script>
</body>
</html>
