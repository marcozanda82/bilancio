<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tracker Adattivo con Builder - v3</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: #f4f7f9; color: #333; margin: 0; padding: 20px; display: flex; justify-content: center; }
        .container { width: 100%; max-width: 800px; background-color: #ffffff; padding: 25px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        h1, h2, h3 { color: #0d47a1; border-bottom: 2px solid #e0e0e0; padding-bottom: 10px; margin-top: 0; }
        h2 { font-size: 1.4em; margin-top: 30px; }
        h3 { font-size: 1.2em; border-bottom: none; margin-top: 15px; margin-bottom: 10px; }
        .sezione { margin-bottom: 25px; padding: 20px; background-color: #fafafa; border: 1px solid #e0e0e0; border-radius: 8px; border-left-width: 5px; }
        label { display: block; margin-bottom: 8px; font-weight: 600; color: #555; }
        input[type="text"], input[type="number"] { width: 100%; padding: 12px; margin-bottom: 15px; border: 1px solid #ccc; border-radius: 6px; box-sizing: border-box; font-size: 1em; }
        button { background-color: #1976d2; color: white; padding: 12px 20px; border: none; border-radius: 6px; cursor: pointer; font-size: 1em; font-weight: 600; transition: background-color 0.3s; }
        button:hover { background-color: #1565c0; }
        #form-allenamento button { background-color: #2e7d32; }
        #form-allenamento button:hover { background-color: #1b5e20; }
        #riepilogo p { font-size: 1.1em; margin: 12px 0; }
        #riepilogo .valore-grande { font-weight: 700; font-size: 1.4em; color: #d32f2f; }
        #riepilogo .valore-consumato { font-weight: 600; color: #1976d2; }
        #riepilogo .valore-bruciato { font-weight: 600; color: #2e7d32; }
        progress { width: 100%; height: 25px; border-radius: 6px; margin-top: 5px; }
        table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid #ddd; vertical-align: middle; }
        th { background-color: #f2f2f2; font-weight: 600; }
        .delete-btn { background-color: transparent; border: none; color: #d32f2f; font-size: 1.3em; font-weight: bold; cursor: pointer; padding: 0 8px; border-radius: 50%; line-height: 1; }
        .delete-btn:hover { background-color: #ffebee; color: #b71c1c; }
        .proiezione-ok { border-left-color: #4caf50; } .proiezione-attenzione { border-left-color: #ff9800; } .proiezione-pericolo { border-left-color: #f44336; } .proiezione-neutra { border-left-color: #9e9e9e; }
        
        .builder-riga { display: grid; grid-template-columns: 2fr 1fr 1fr 1fr 1.5fr auto; gap: 10px; align-items: center; margin-bottom: 10px; padding-bottom: 10px; border-bottom: 1px solid #eee; }
        .builder-riga label { font-size: 0.8em; margin-bottom: 2px; }
        .builder-riga input { margin-bottom: 0; }
        .riga-risultato { text-align: center; font-weight: 600; background-color: #f0f4f8; padding: 5px; border-radius: 4px; }
        #builder-riepilogo { background-color: #e8f5e9; padding: 15px; border-radius: 6px; margin-top: 20px; }
        #riepilogo-pasto-table tfoot td { font-weight: bold; border-top: 2px solid #333; background-color: #dcedc8; }
        #btn-aggiungi-riga { background-color: #5c6bc0; margin-bottom: 15px; }
        #btn-registra-pasto { width: 100%; padding: 15px; font-size: 1.2em; background-color: #d84315; }
        #btn-registra-pasto:disabled { background-color: #ccc; cursor: not-allowed; }
        @media (max-width: 700px) { .builder-riga { grid-template-columns: 1fr 1fr; } .riga-risultato, .builder-riga .delete-btn { grid-column: 1 / -1; text-align: right; } }
    </style>
</head>
<body>
    <div class="container">
        <h1>Tracker Adattivo con Builder</h1>
        
        <div id="proiezione" class="sezione proiezione-neutra"><h2>Proiezione del Trend</h2><p id="testo-proiezione">Inizia a registrare i dati per vedere un'analisi.</p></div>
        
        <div id="riepilogo" class="sezione">
            <h2>Riepilogo di Oggi</h2>
            </div>

        <div id="meal-builder" class="sezione">
            <h2>Costruttore e Registrazione Pasto</h2>
            <label for="nome-pasto">Nome del Pasto (es. Pranzo, Cena)</label>
            <input type="text" id="nome-pasto" placeholder="Pranzo di oggi">
            <div id="builder-righe-container"></div>
            <button id="btn-aggiungi-riga">+ Aggiungi Alimento</button>
            
            <div id="builder-riepilogo">
                <h3>Riepilogo Pasto Corrente</h3>
                <table id="riepilogo-pasto-table">
                    <thead>
                        <tr>
                            <th>Alimento</th>
                            <th>Proteine (g)</th>
                            <th>Calorie (kcal)</th>
                            <th>Azione</th> </tr>
                    </thead>
                    <tbody id="riepilogo-pasto-body"></tbody>
                    <tfoot>
                        <tr>
                            <td><strong>TOTALE</strong></td>
                            <td><strong id="builder-totale-proteine">0.0</strong></td>
                            <td><strong id="builder-totale-calorie">0</strong></td>
                            <td></td> </tr>
                    </tfoot>
                </table>
            </div>
            
            <button id="btn-registra-pasto" style="margin-top: 20px;" disabled>Registra Pasto nel Diario</button>
        </div>

        <div class="sezione"><h2>Registra Allenamento</h2></div>
        <div class="sezione"><h2>Diario Giornaliero</h2></div>
    </div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    // === OBIETTIVI DI BASE ===
    const OBIETTIVO_BASE_PROTEINE = 150; 
    const OBIETTIVO_BASE_CALORIE = 1770;
    
    // === STATO GLOBALE ===
    let obiettivoCorrenteProteine = OBIETTIVO_BASE_PROTEINE;
    let obiettivoCorrenteCalorie = OBIETTIVO_BASE_CALORIE;
    let datiGiornalieri = { proteine: 0, calorie: 0, log: [], workoutCalorie: 0, workoutLog: [] };
    let rigaIdCounter = 0; // Contatore per ID unici delle righe

    // === RIFERIMENTI DOM ===
    const builderContainer = document.getElementById('builder-righe-container');
    const btnAggiungiRiga = document.getElementById('btn-aggiungi-riga');
    const btnRegistraPasto = document.getElementById('btn-registra-pasto');
    const inputNomePasto = document.getElementById('nome-pasto');
    const riepilogoPastoBody = document.getElementById('riepilogo-pasto-body');
    const spanBuilderProteine = document.getElementById('builder-totale-proteine');
    const spanBuilderCalorie = document.getElementById('builder-totale-calorie');

    // === LOGICA DEL MEAL BUILDER ===
    const creaRigaBuilder = () => {
        rigaIdCounter++;
        const rigaDiv = document.createElement('div');
        rigaDiv.className = 'builder-riga';
        rigaDiv.dataset.rowId = rigaIdCounter; // Assegna ID unico alla riga del builder
        rigaDiv.innerHTML = `
            <div><label>Alimento</label><input type="text" class="builder-input" data-field="desc" placeholder="es. Pollo"></div>
            <div><label>Prot/100g</label><input type="number" class="builder-input" data-field="prot" min="0" step="0.1"></div>
            <div><label>Kcal/100g</label><input type="number" class="builder-input" data-field="kcal" min="0"></div>
            <div><label>Quantità (g)</label><input type="number" class="builder-input" data-field="qta" min="0"></div>
            <div class="riga-risultato">
                <span data-result="prot">0.0</span> g P / <span data-result="kcal">0</span> kcal
            </div>
            <button class="delete-btn builder-delete-riga" title="Rimuovi riga">&times;</button>
        `;
        builderContainer.appendChild(rigaDiv);
    };

    const aggiornaCalcoliPasto = () => {
        let totalePastoProt = 0;
        let totalePastoKcal = 0;
        riepilogoPastoBody.innerHTML = '';
        
        builderContainer.querySelectorAll('.builder-riga').forEach(riga => {
            const rowId = riga.dataset.rowId; // Recupera ID unico
            const desc = riga.querySelector('[data-field="desc"]').value || 'N/D';
            const p100 = parseFloat(riga.querySelector('[data-field="prot"]').value) || 0;
            const k100 = parseFloat(riga.querySelector('[data-field="kcal"]').value) || 0;
            const qta = parseFloat(riga.querySelector('[data-field="qta"]').value) || 0;
            const pRiga = (p100 / 100) * qta;
            const kRiga = Math.round((k100 / 100) * qta);

            riga.querySelector('[data-result="prot"]').textContent = pRiga.toFixed(1);
            riga.querySelector('[data-result="kcal"]').textContent = kRiga;

            totalePastoProt += pRiga;
            totalePastoKcal += kRiga;

            if (qta > 0) {
                const newSummaryRow = riepilogoPastoBody.insertRow();
                // Aggiunge la riga al riepilogo con il pulsante di cancellazione e l'ID
                newSummaryRow.innerHTML = `
                    <td>${desc}</td>
                    <td>${pRiga.toFixed(1)}</td>
                    <td>${kRiga}</td>
                    <td><button class="delete-btn" data-summary-delete-id="${rowId}" title="Cancella ingrediente">&times;</button></td>
                `;
            }
        });
        
        spanBuilderProteine.textContent = totalePastoProt.toFixed(1);
        spanBuilderCalorie.textContent = Math.round(totalePastoKcal);
        btnRegistraPasto.disabled = (totalePastoKcal <= 0);
    };

    btnAggiungiRiga.addEventListener('click', creaRigaBuilder);
    
    btnRegistraPasto.addEventListener('click', () => {
        const nomePasto = inputNomePasto.value.trim() || "Pasto Calcolato";
        const protPasto = parseFloat(spanBuilderProteine.textContent);
        const kcalPasto = parseInt(spanBuilderCalorie.textContent, 10);

        if (kcalPasto > 0) {
            datiGiornalieri.proteine += protPasto;
            datiGiornalieri.calorie += kcalPasto;
            datiGiornalieri.log.push({ desc: nomePasto, prot: protPasto, cal: kcalPasto });
            
            salvaDati();
            aggiornaUI();

            builderContainer.innerHTML = '';
            creaRigaBuilder();
            inputNomePasto.value = '';
            aggiornaCalcoliPasto();
        }
    });

    // === EVENT LISTENERS GENERALI ===
    
    // LISTENER UNIFICATO E CORRETTO PER TUTTE LE CANCELLAZIONI
    document.body.addEventListener('click', (e) => {
        const target = e.target;
        
        // Cancella riga dal builder (X nel costruttore)
        if (target.classList.contains('builder-delete-riga')) {
            target.closest('.builder-riga').remove();
            aggiornaCalcoliPasto();
            return;
        }

        // NUOVA LOGICA: Cancella riga dal riepilogo pasto (X nella tabella di riepilogo)
        if (target.hasAttribute('data-summary-delete-id')) {
            const idToDelete = target.dataset.summaryDeleteId;
            const builderRowToDelete = document.querySelector(`.builder-riga[data-row-id="${idToDelete}"]`);
            if (builderRowToDelete) {
                builderRowToDelete.remove();
                aggiornaCalcoliPasto(); // Ricalcola tutto
            }
            return;
        }

        // Cancella voce dai diari principali (Pasti e Allenamenti)
        if (target.classList.contains('delete-btn') && target.hasAttribute('data-type')) {
            if (!confirm('Sei sicuro di voler cancellare questa voce?')) return;
            const type = target.dataset.type;
            const index = parseInt(target.dataset.index, 10);
            
            if (type === 'pasto' && datiGiornalieri.log[index]) {
                const item = datiGiornalieri.log[index];
                datiGiornalieri.proteine -= item.prot;
                datiGiornalieri.calorie -= item.cal;
                datiGiornalieri.log.splice(index, 1);
            } else if (type === 'allenamento' && datiGiornalieri.workoutLog[index]) {
                const item = datiGiornalieri.workoutLog[index];
                datiGiornalieri.workoutCalorie -= item.cal;
                datiGiornalieri.workoutLog.splice(index, 1);
            }
            salvaDati();
            aggiornaUI();
        }
    });

    // LISTENER PER INPUT NEL BUILDER
    builderContainer.addEventListener('input', e => {
        if (e.target.classList.contains('builder-input')) {
            aggiornaCalcoliPasto();
        }
    });
    
    // === INIZIALIZZAZIONE E FUNZIONI NON MODIFICATE (COMPRESSE PER LEGGIBILITÀ) ===
    const placeholderFunction = () => {
        // Questa funzione serve solo a contenere il codice non modificato per non ripeterlo
        // e rendere la risposta più leggibile. Nel file .html reale, questo codice
        // è presente per intero all'interno dello script principale.
        
        const salvaDati = () => localStorage.setItem('trackerDati', JSON.stringify({ data: new Date().toISOString().split('T')[0], dati: datiGiornalieri }));
        const caricaDati = () => {
            const datiSalvati = JSON.parse(localStorage.getItem('trackerDati'));
            if (datiSalvati && datiSalvati.data === new Date().toISOString().split('T')[0]) {
                datiGiornalieri = datiSalvati.dati;
                if (!datiGiornalieri.workoutCalorie) datiGiornalieri.workoutCalorie = 0;
                if (!datiGiornalieri.workoutLog) datiGiornalieri.workoutLog = [];
            } else {
                salvaDati(); 
            }
            aggiornaUI();
        };
        const ricalcolaObiettivi = () => {
            obiettivoCorrenteCalorie = OBIETTIVO_BASE_CALORIE + datiGiornalieri.workoutCalorie;
            obiettivoCorrenteProteine = OBIETTIVO_BASE_PROTEINE + Math.round(datiGiornalieri.workoutCalorie / 20);
        };
        const aggiornaUI = () => {
            ricalcolaObiettivi();
            document.getElementById('riepilogo').innerHTML = `<h2>Riepilogo di Oggi</h2><p>Proteine restanti: <span id="restanti-proteine" class="valore-grande">${(obiettivoCorrenteProteine - datiGiornalieri.proteine).toFixed(1)}</span> g</p><progress id="progress-proteine" value="${datiGiornalieri.proteine}" max="${obiettivoCorrenteProteine}"></progress><p>Consumate: <span id="totale-proteine" class="valore-consumato">${datiGiornalieri.proteine.toFixed(1)}</span> g / <span id="obiettivo-proteine">${obiettivoCorrenteProteine.toFixed(0)}</span> g</p><hr style="margin: 20px 0; border: 1px solid #eee;"><p>Calorie restanti: <span id="restanti-calorie" class="valore-grande">${obiettivoCorrenteCalorie - datiGiornalieri.calorie}</span> kcal</p><progress id="progress-calorie" value="${datiGiornalieri.calorie}" max="${obiettivoCorrenteCalorie}"></progress><p>Consumate: <span id="totale-calorie" class="valore-consumato">${datiGiornalieri.calorie}</span> kcal / <span id="obiettivo-calorie">${obiettivoCorrenteCalorie}</span> kcal</p><p style="margin-top:15px;">Calorie Bruciate (Workout): <span id="workout-calories-totali" class="valore-bruciato">${datiGiornalieri.workoutCalorie}</span> kcal</p>`;
            document.querySelector('.sezione:nth-of-type(4)').innerHTML = `<h2>Registra Allenamento</h2><form id="form-allenamento"><input type="text" id="descrizione-allenamento" placeholder="Descrizione Allenamento"><input type="number" id="calorie-bruciate" min="0" required placeholder="Calorie Bruciate (kcal)"><button type="submit">Aggiungi Allenamento</button></form><table id="log-allenamenti" style="display:${datiGiornalieri.workoutLog.length > 0 ? 'table' : 'none'}"><thead><tr><th>Descrizione</th><th>Calorie Bruciate</th><th>Azione</th></tr></thead><tbody id="log-allenamenti-body"></tbody></table>`;
            document.querySelector('.sezione:nth-of-type(5)').innerHTML = `<h2>Diario Giornaliero</h2><table id="log-pasti"><thead><tr><th>Descrizione</th><th>Proteine (g)</th><th>Calorie (kcal)</th><th>Azione</th></tr></thead><tbody id="log-body"></tbody></table>`;
            document.getElementById('log-body').innerHTML = datiGiornalieri.log.map((item, index) => `<tr><td>${item.desc}</td><td>${item.prot.toFixed(1)}</td><td>${item.cal}</td><td><button class="delete-btn" data-type="pasto" data-index="${index}" title="Cancella pasto">&times;</button></td></tr>`).join('');
            document.getElementById('log-allenamenti-body').innerHTML = datiGiornalieri.workoutLog.map((item, index) => `<tr><td>${item.desc}</td><td>${item.cal}</td><td><button class="delete-btn" data-type="allenamento" data-index="${index}" title="Cancella allenamento">&times;</button></td></tr>`).join('');
            aggiornaProiezione();
        };
        const aggiornaProiezione = () => {
            const { calorie, proteine } = datiGiornalieri; let testo = ''; let classeCss = 'sezione';
            if (calorie === 0 && datiGiornalieri.workoutCalorie === 0) { testo = "Inizia a registrare i dati per vedere un'analisi."; classeCss += ' proiezione-neutra'; }
            else if (calorie > obiettivoCorrenteCalorie && proteine < obiettivoCorrenteProteine * 0.9) { testo = "PERICOLO: Stai superando il limite calorico con un apporto proteico insufficiente. Questo trend porta ad un accumulo di grasso e potrebbe causare una perdita di massa muscolare."; classeCss += ' proiezione-pericolo'; }
            else if (calorie > obiettivoCorrenteCalorie) { testo = "ATTENZIONE: L'apporto proteico è buono, ma hai superato il tuo obiettivo calorico. Stai vanificando il deficit necessario per perdere grasso."; classeCss += ' proiezione-attenzione'; }
            else if (proteine < obiettivoCorrenteProteine * 0.8 && calorie > obiettivoCorrenteCalorie * 0.6) { testo = "ATTENZIONE: Le calorie sono sotto controllo, ma l'apporto proteico è ancora troppo basso. Ricorda che senza abbastanza proteine, il corpo potrebbe ricavare energia dai muscoli. Dai priorità alle proteine!"; classeCss += ' proiezione-attenzione'; }
            else { testo = "TREND POSITIVO: Eccellente! Sei perfettamente in linea. Stai mantenendo un deficit calorico e fornendo al corpo le proteine necessarie per proteggere i muscoli. Continua così!"; classeCss += ' proiezione-ok'; }
            document.getElementById('proiezione').className = classeCss; document.getElementById('testo-proiezione').textContent = testo;
        };
        document.getElementById('form-allenamento').addEventListener('submit', e => {
            e.preventDefault(); const desc = document.getElementById('descrizione-allenamento').value || 'Allenamento'; const cal = parseInt(document.getElementById('calorie-bruciate').value, 10);
            if (isNaN(cal) || cal <= 0) return; datiGiornalieri.workoutCalorie += cal; datiGiornalieri.workoutLog.push({ desc, cal }); salvaDati(); aggiornaUI(); e.target.reset();
        });
        caricaDati();
    };
    placeholderFunction();
    creaRigaBuilder(); // Chiamata iniziale
});
</script>
</body>
</html>
